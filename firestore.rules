rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isSignedIn() { return request.auth != null; }
    function userDoc() { return get(/databases/$(database)/documents/users/$(request.auth.uid)); }
    function hasRole(role) { return isSignedIn() && userDoc().data.role == role; }

    // USERS
    match /users/{userId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update, delete: if isSignedIn() && request.auth.uid == userId;
    }

    // JOBS
    match /jobs/{jobId} {
      // Any signed-in user can read jobs
      allow read: if isSignedIn();

      // Contractors create jobs; enforce ownership and basic schema
      allow create: if hasRole('contractor')
        && request.resource.data.contractorId == request.auth.uid
        && request.resource.data.status == 'active'
        && (request.resource.data.timestamp is int || request.resource.data.timestamp is timestamp)
        && request.resource.data.title is string
        && request.resource.data.category is string
        && request.resource.data.location is string
        && (request.resource.data.requirements is string || !("requirements" in request.resource.data))
        && (request.resource.data.bidLimit is int || request.resource.data.bidLimit is number || !("bidLimit" in request.resource.data));

      // Only the owner contractor can update their job; restrict which fields can change
      allow update: if isSignedIn()
        && resource.data.contractorId == request.auth.uid
        && request.resource.data.contractorId == resource.data.contractorId
        && (("status" in request.resource.data) ? (request.resource.data.status in ['active','closed']) : true)
        && (!("timestamp" in request.resource.data) || (request.resource.data.timestamp is int || request.resource.data.timestamp is timestamp))
        && (!("title" in request.resource.data) || request.resource.data.title == resource.data.title)
        && (!("category" in request.resource.data) || request.resource.data.category == resource.data.category)
        && (!("startDate" in request.resource.data) || request.resource.data.startDate == resource.data.startDate)
        && (!("location" in request.resource.data) || request.resource.data.location == resource.data.location)
        && (!("imageUrl" in request.resource.data) || request.resource.data.imageUrl == resource.data.imageUrl)
        && (!("requirements" in request.resource.data) || request.resource.data.requirements == resource.data.requirements)
        && (!("bidLimit" in request.resource.data) || request.resource.data.bidLimit == resource.data.bidLimit)
        && (!("winnerUserId" in request.resource.data) || request.resource.data.winnerUserId is string);
    }

    // BIDS under a job
    match /jobs/{jobId}/bids/{bidId} {
      // Contractor who owns the job can read all bids; others can read their own
      allow read: if isSignedIn() && (
        get(/databases/$(database)/documents/jobs/$(jobId)).data.contractorId == request.auth.uid ||
        resource.data.bidderId == request.auth.uid
      );

      // Labourer or agent can create a bid while job is active
      allow create: if isSignedIn()
        && exists(/databases/$(database)/documents/users/$(request.auth.uid))
        && (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'labour' ||
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'labourer' ||
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'agent')
        && request.resource.data.bidderId == request.auth.uid
        && exists(/databases/$(database)/documents/jobs/$(jobId))
        && get(/databases/$(database)/documents/jobs/$(jobId)).data.status == 'active'
        && (request.resource.data.timestamp is int || request.resource.data.timestamp is timestamp || !("timestamp" in request.resource.data))
        && request.resource.data.bidAmount is number
        && request.resource.data.bidAmount > 0
        && (request.resource.data.status == 'pending' || !("status" in request.resource.data));

      // Only contractor owning the job can update bid status
      allow update: if isSignedIn()
        && get(/databases/$(database)/documents/jobs/$(jobId)).data.contractorId == request.auth.uid
        && request.resource.data.status in ['pending','accepted','rejected']
        && request.resource.data.bidderId == resource.data.bidderId
        && request.resource.data.bidAmount == resource.data.bidAmount
        && request.resource.data.jobId == resource.data.jobId
        && (!("labourerIdIfAgent" in request.resource.data) || !("labourerIdIfAgent" in resource.data) || request.resource.data.labourerIdIfAgent == resource.data.labourerIdIfAgent);
    }

    // CHATS
    match /chats/{chatId} {
      // Allow read if user is in the chat's userIds array
      allow read: if isSignedIn() && (
        !exists(/databases/$(database)/documents/chats/$(chatId)) ||
        request.auth.uid in resource.data.userIds
      );
      // Allow update if user is in the chat
      allow update: if isSignedIn() && request.auth.uid in resource.data.userIds;
      // Create only if current user is part of the chat
      allow create: if isSignedIn() && request.auth.uid in request.resource.data.userIds;
    }

    // MESSAGES
    match /chats/{chatId}/messages/{messageId} {
      allow read: if isSignedIn() && request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.userIds;
      allow create: if isSignedIn()
        && request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.userIds
        && request.resource.data.senderId == request.auth.uid
        && request.resource.data.message is string
        && (request.resource.data.timestamp is int || request.resource.data.timestamp is timestamp || !("timestamp" in request.resource.data));
    }
  }
}
